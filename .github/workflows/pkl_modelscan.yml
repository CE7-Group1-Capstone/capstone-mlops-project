# ModelScan: Scan Protection Against Model Serialization Attacks
#   https://github.com/protectai/modelscan 
name: Protectai/Modelscan

on:
  #pull_request:
  #  branches: [ "main" ]
  #  paths:
  #      - '*.pkl'
  #      - 'models/*.pkl'
  #      - '*.pkl.dvc'
  #      - 'models/*.pkl.dvc'
  workflow_dispatch:
    inputs:
      confirm:
        description: "Do you want to proceed? (y/n)"
        required: true
        default: n
        type: choice
        options:
          - 'y'
          - 'n'
  workflow_call:
    inputs:
      skip_confirmation:
        required: true
        type: string

jobs:
  pre-deploy:
    runs-on: ubuntu-latest
    steps:
      - run: echo "This job is automatically triggered by a ${{ github.event_name }} event."

  ml-model-scan:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' &&  github.event.inputs.confirm == 'y' }} || ${{ github.event_name == 'workflow_call' && inputs.skip_confirmation == 'true' }}
    
    steps:
    - name: Check out repository code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.12'

    - name: Install and upgrade pip
      run: python -m pip install --upgrade pip

    - name: Install Snyk CLI
      run: pip install modelscan

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

    - name: Install DVC
      run: |
        pip install dvc[s3]

    # Only pull from DVC the last-commited ML model if 
    # there is no model already exisiting locally in the event
    # of 'workflow_dispatch' trigger - manual workkflow case
    - name: Pull from DVC
      run: |
        if [[ -f "models/model.pkl.dvc" && -f "models/model.pkl" ]]; then
           echo "A Ml Model is already existing in the 'models' sub-directory!" 
        elif [[ -f "models/model.pkl" ]]; then
           echo "A Ml Model is already existing in the 'models' sub-directory!"
        else
           dvc pull models/model.pkl
        fi

    - name: Scan ML model
      run: modelscan -p models/model.pkl
